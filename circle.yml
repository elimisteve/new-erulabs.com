machine:
  python:
    version: 2.7

dependencies:
  cache_directories:
    - /home/ubuntu/bin
  pre:
    - pip install ansible
    - wget https://releases.hashicorp.com/terraform/0.6.16/terraform_0.6.16_linux_amd64.zip
    - unzip terraform_0.6.16_linux_amd64.zip -d /home/ubuntu/bin
    - echo $VAULT_SECRET > .secret
  override:
    - chmod +x bin/*
    - ./bin/vault.sh decrypt secrets/account.json.secret > secrets/account.json.plain
    - ./bin/clean.sh
    - ./bin/build.sh
  post:
    - rm -r .secret
    - rm -r secrets/*.plain

test:
  override:
    - ./bin/test.sh

deployment:
  master:
    branch: [test, master]
    commands:
      - ./bin/inf.sh $CIRCLE_BRANCH
      - ./bin/playbook.sh $CIRCLE_BRANCH
      - ./bin/deploy.sh $CIRCLE_BRANCH
